---
## Author
author:
  name: Жукова Арина Александровна
  degrees: 3rd year student
  orcid: 0000-0002-0877-7063
  email: 1132239120@rudn.ru
  affiliation:
    - name: Российский университет дружбы народов
      country: Российская Федерация
      postal-code: 117198
      city: Москва
      address: ул. Миклухо-Маклая, д. 6

## Title
title: "Лабораторная работа №12"
subtitle: " Синхронизация времени"
license: "CC BY"
---


# Цель работы

Получение навыков по управлению системным временем и настройке синхронизации времени.

# Задание

1. Изучите команды по настройке параметров времени.
2. Настройте сервер в качестве сервера синхронизации времени для локальной сети.
3. Напишите скрипты для Vagrant, фиксирующие действия по установке и настройке
NTP-сервера и клиента.

# Теоретическое введение

## Управление системным и аппаратным временем

В Linux различают:
- **Аппаратное время** - время аппаратных часов (RTC), хранимое на материнской плате
- **Системное время** - время, поддерживаемое ядром ОС (отсчёт с 1.01.1970 - "Unix epoch")

**Основные команды:**
- `hwclock` - работа с аппаратными часами
  - `hwclock --show` - показать аппаратное время
  - `hwclock --systohc` - синхронизировать аппаратные часы с системными
- `date` - работа с системным временем
  - `date` - показать текущее время
  - `date MMDDhhmmYYYY` - установить время
- `timedatectl` - универсальная утилита управления временем
  - `timedatectl` - показать текущие настройки
  - `timedatectl set-timezone Europe/Moscow` - установить часовой пояс
  - `timedatectl set-time "2018-09-06 12:34:59"` - установить время

## Синхронизация времени по NTP

**NTP (Network Time Protocol)** - протокол для синхронизации времени в сети с использованием иерархической структуры серверов (stratum уровней).

**Службы синхронизации в Linux:**
- `ntpd` - классическая реализация
- `chrony` - современная реализация (рекомендуется)

**Основные команды chrony:**
- `chronyc sources` - список серверов синхронизации
- `chronyc sourcestats` - статистика серверов
- `chronyc tracking` - детальная информация о синхронизации

**Обозначения в выводе `chronyc sources`:**
- **Столбец M**: `^` - сервер, `=` - одноранговый узел, `#` - локальный источник
- **Столбец S**: `*` - текущий источник, `+` - приемлемый, `?` - нет связи, `×` - фальшивый, `~` - нестабильный
- **Stratum** - уровень в иерархии (чем меньше, тем точнее)
- **Poll** - интервал опроса (в степенях 2)
- **Reach** - успешность опросов (377 = все успешны)

# Выполнение лабораторной работы

## Настройка параметров времени

1. На сервере и клиенте посмотрите параметры настройки даты и времени ([рис. @fig-001]- [рис. @fig-002]).

![параметры настройки даты и времени на сервере](image/1.png){#fig-001 width=70%}

![параметры настройки даты и времени на клиенте](image/2.png){#fig-002 width=70%}

Установка временной зоны ([рис. @fig-003]- [рис. @fig-004]).

![Временная зона на сервере](image/3.png){#fig-003 width=70%}

![Временная зона на клиенте](image/4.png){#fig-004 width=70%}

Просмотр доступных временных зон  ([рис. @fig-006]).

![Просмотр временых зон в Европе](image/6.png){#fig-006 width=70%}

2. На сервере и клиенте посмотрите текущее системное время  ([рис. @fig-005]- [рис. @fig-007]).

![Текущее системное время на сервере](image/5.png){#fig-005 width=70%}

![Текущее системное время на клиенте](image/7.png){#fig-007 width=70%}

Просматриваем вчерашнюю дату и дату следующего понедельника ([рис. @fig-008]).

![Разные параметры date](image/8.png){#fig-008 width=70%}

3. На сервере и клиенте посмотрите аппаратное время ([рис. @fig-009]-[рис. @fig-0010]).

![Аппаратное время на сервере](image/9.png){#fig-009 width=70%}

![Аппаратное время на клиенте](image/10.png){#fig-0010 width=70%}

## Управление синхронизацией времени

1. Установите на сервере необходимое программное обеспечение ([рис. @fig-011]).

![Установка ПО](image/11.png){#fig-011 width=70%}

Необходимое ПО уже было установлено.

2. Проверьте источники времени на клиенте и на сервере ([рис. @fig-012]-[рис. @fig-013]).

![Источники времени на сервере](image/12.png){#fig-012 width=70%}

![Источники времени на клиенте](image/13.png){#fig-013 width=70%}

### Пояснения:

#### Для сервера

**Текущие источники времени:**
- `^* 151.0.2.53` - **активный источник синхронизации** (стратум 2)
- `^+ 90.188.9.144`, `^+ 62.76.113.232` - **приемлемые резервные источники** (стратум 3)
- `^- 45.141.102.99` - **неприемлемый источник** (стратум 2)

**Ключевые показатели:**
- **Stratum**: 2-3 (высокая точность)
- **Poll**: 10 (интервал опроса ≈ 2¹⁰ = 1024 сек)
- **Reach**: 377 (все последние 8 опросов успешны)
- **Offset**: от -5473 до +4778 микросекунд (хорошая точность)

#### Для клиента

**Текущие источники времени:**
- `^* 92.118.113.65` - **активный источник синхронизации** (стратум 2)
- `^+ time.cloudflare.com`, `^+ 45.141.102.99` - **приемлемые резервные источники**
- `^_ 85.193.65.152` - **источник с потерями связи** (Reach=277)

**Ключевые показатели:**
- **Stratum**: 2-3 (высокая точность)
- **Poll**: 8 (интервал опроса ≈ 2⁸ = 256 сек - чаще чем на сервере)
- **Reach**: 277 на одном источнике (не все опросы успешны)
- **Offset**: от +17 наносекунд до +9453 микросекунд

3. На сервере откройте на редактирование файл /etc/chrony.conf и добавьте строку ([рис. @fig-014]).

![Изменение файла chrony.conf на сервере](image/14.png){#fig-014 width=70%}

4. На сервере перезапустите службу chronyd. Настройте межсетевой экран на сервере ([рис. @fig-015]).

![Перезапуск и настройка межсетевого экрана на сервере](image/15.png){#fig-015 width=70%}

5. На клиенте откройте файл /etc/chrony.conf и добавьте строку (вместо user укажите
свой логин) ([рис. @fig-016]).

![Изменение файла chrony.conf на клиенте](image/16.png){#fig-016 width=70%}

6. На клиенте перезапустите службу chronyd, проверьте источники времени на клиенте и на сервере ([рис. @fig-017]-[рис. @fig-018]).

![Перезапуск службы и проверка источников на клиенте](image/17.png){#fig-017 width=70%}

![Проверка источников времени на сервере](image/18.png){#fig-018 width=70%}

### Пояснения: 

#### Для сервера - **НЕСТАБИЛЬНОЕ СОСТОЯНИЕ**:

**После перезапуска службы chronyd сервер находится в процессе восстановления синхронизации:**

- `^* 51.250.35.68` - **текущий активный источник** (стратум 2), но с проблемами:
  - **Reach: 17** (из 377) - только 7 из последних 8 опросов успешны
  - **Погрешность: ±8652us** - высокая нестабильность

- `^? mskm9-ntp0lc.ntppool.yan>`, `^? yggno.de` - **источники с потерями связи**:
  - **Reach: 1 и 3** - крайне низкая надежность
  - Символ `?` указывает на проблемы с подключением

- `^- 90.188.6.85` - **неприемлемый источник** с большой погрешностью (±140ms)

**Вывод по серверу:** Служба chronyd только что перезапущена и находится в процессе установления стабильных соединений с NTP-серверами.

#### Для клиента - **СТАБИЛЬНОЕ СОСТОЯНИЕ**:

**Клиент успешно синхронизирован после перезапуска:**

- `^* 89.169.135.41` - **активный источник синхронизации** (стратум 2)
  - **Reach: 17** - хорошая стабильность соединения
  - **Offset: +597us** - отличная точность

- `^+ 92.63.179.96`, `^+ mail.aazhukova.net` - **приемлемые резервные источники**
  - Стратум 2-3, хорошие показатели точности

- `^- fw.barnaul.fxclub.org`, `^- mail.rashnikov.name` - **неприемлемые источники**
  - Используются как резерв, но не для активной синхронизации

**Особенность:** Клиент использует `mail.aazhukova.net` как источник, что указывает на локальную синхронизацию в сети.

7. Посмотрите подробную информацию о синхронизации ([рис. @fig-019]).

![Подробная информация о синхранизации](image/19.png){#fig-019 width=70%}

###Пояснения:

#### Основные параметры синхронизации:

1. **Reference ID**: `33FA2344 (51.250.35.68)`
   - Текущий источник синхронизации - сервер с IP 51.250.35.68

2. **Stratum**: `3`
   - Уровень в иерархии NTP. Сервер синхронизирован с источником стратума 2, что является хорошим показателем

3. **System time**: `0.000854651 seconds slow of NTP time`
   - Системное время отстает от NTP времени всего на ~0.85 миллисекунды - отличная точность

4. **Last offset**: `-0.013069455 seconds`
   - Последнее измеренное смещение: -13 миллисекунд (система была немного впереди)

5. **RMS offset**: `0.010593251 seconds`
   - Среднеквадратичное смещение: ~10.6 миллисекунд - хорошая стабильность

#### Технические параметры:

6. **Frequency**: `496.451 ppm fast`
   - Частота системных часов убегает вперед на 496.451 части на миллион (довольно высокий дрейф)

7. **Residual freq**: `-214.421 ppm`
   - Остаточная частота после коррекции: -214.421 ppm

8. **Skew**: `15.915 ppm`
   - Погрешность оценки частоты: 15.915 ppm - низкое значение, хорошая точность оценки

9. **Root delay**: `0.027708286 seconds`
    - Общая задержка до первичного источника: ~27.7 миллисекунд

10. **Root dispersion**: `0.020884650 seconds`
    - Максимальная погрешность: ~20.9 миллисекунд

11. **Update interval**: `65.2 seconds`
    - Интервал обновления: 65.2 секунды

12. **Leap status**: `Normal`
    - Статус високосной секунды: нормальный (не ожидается корректировок)


## Внесение изменений в настройки внутреннего окружения виртуальных машин
 
1. На виртуальной машине server перейдите в каталог для внесения изменений в настройки внутреннего окружения /vagrant/provision/server/, создайте в нём каталог ntp, в который поместите в соответствующие подкаталоги конфигурационные файлы. В каталоге /vagrant/provision/server создайте исполняемый файл ntp.sh ([рис. @fig-021]).

![Копирование файлов в server, создание ntp.sh](image/21.png){#fig-021 width=70%}

Открыв его на редактирование, пропишите в нём следующий скрипт ([рис. @fig-022]).

![Файл ntp.sh в каталоге server](image/21.png){#fig-022 width=70%}

2. На виртуальной машине client перейдите в каталог для внесения изменений в настройки внутреннего окружения /vagrant/provision/client/, создайте в нём каталог ntp, в который поместите в соответствующие подкаталоги конфигурационные файлы.  В каталоге /vagrant/provision/client создайте исполняемый файл ntp.sh  ([рис. @fig-023]).

![Копирование файлов в client, создание ntp.sh](image/22.png){#fig-023 width=70%}

Открыв его на редактирование, пропишите в нём следующий скрипт ([рис. @fig-024]).

![Файл ntp.sh в каталоге client](image/23.png){#fig-024 width=70%}

3. Для отработки созданных скриптов во время загрузки виртуальных машин server и client в конфигурационном файле Vagrantfile необходимо добавить в соответствующих разделах конфигураций для сервера и клиента  ([рис. @fig-025]-[рис. @fig-026]).

![Файл Vagrantfile](image/25.png){#fig-025 width=70%}

![Файл Vagrantfile](image/26.png){#fig-026 width=70%}

# Выводы

Во время выполнения лабораторной работы я получила навыки по управлению системным временем и настройке синхронизации времени.

# Ответы на контрольные вопросы

1. Почему важна точная синхронизация времени для служб баз данных?

Для обеспечения консистентности транзакций в распределенных системах и корректной работы механизмов репликации.

2. Почему служба проверки подлинности Kerberos сильно зависит от правильной синхронизации времени?

Kerberos использует временные метки для предотвращения replay-атак, расхождение более 5 минут приводит к отказу в аутентификации.

3. Какая служба используется по умолчанию для синхронизации времени на RHEL 7?

chronyd

4. Какова страта по умолчанию для локальных часов?

Страта 3 при использовании внешних серверов, страта 10 при потере синхронизации.

5. Какой порт брандмауэра должен быть открыт, если вы настраиваете свой сервер как одноранговый узел NTP?

Порт 123/udp

6. Какую строку вам нужно включить в конфигурационный файл chrony, если вы хотите быть сервером времени, даже если внешние серверы NTP недоступны?

`local stratum 10`

7. Какую страту имеет хост, если нет текущей синхронизации времени NTP?

Страта 16 (не синхронизирован)

8. Какую команду вы бы использовали на сервере с chrony, чтобы узнать, с какими серверами он синхронизируется?

`chronyc sources`

9. Как вы можете получить подробную статистику текущих настроек времени для процесса chrony вашего сервера?

`chronyc tracking`

# Список литературы{.unnumbered}

::: {#refs}
:::
